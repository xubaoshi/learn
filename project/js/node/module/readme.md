# nodejs 模块机制 #
## 1. Node中引入模块的步骤： ##
**（1）路径分析<br>（2）文件定位<br>（3）编译执行<br>**
## 2. Node中模块分为两类 ##
**Node提供的模块（核心模块）、用户编写的模块(文件模块)。<br>**

**核心模块：**<br>部分核心模块在Node源码的编译过程中，被编译进了二进制执行文件。Node启动时部分核心模块直接被加载到内存中，所以在引入这些模块时，文件定位及编译执行可以省略掉，并且路径分析中优先判断，加载速度最快.<br>
**文件模块：**
运行时动态加载，需要完整的路径分析、文件定位、编译执行过程，速度比核心模块慢。
## 3. 优先从缓存加载##
Node对引入过的模块进行缓存，以减少引入时的开销。浏览器缓存的仅仅是缓存文件，而Node缓存的是编译执行后的对象。
## 4. 路径分析文件定位##
### 4.1 模块标识符分析###
node通过require方法引入模块，require方法内接受一个表示符作为参数，node基于此标识符进行模块的分析与定位。<br>

	var path = require('path');                                                            // 核心模块  http、fs、path等
	var test1 = require('./test1.json');                                                   // . 或 .. 开始的相对路径的文件模块
	var test2 = require('../test2.json');
	var test3 = require('E:/code/learn/project/js/node/module/test/test3.json');           // 以/开始的绝对路径
	var walk = require('walk');                                                            // 非路径形式的walk模块

**核心模块**的优先级仅次于缓存加载，由于Node的源码编译过程中已经将其编译为二进制编码，因此其加载过程最快。ps:http(node中的核心模块)，如果自定义该模块，引入时如果希望加载成功，必须选择一个不同的标识符或者通过路径引用的方式引用该模块<br>


	var http = require('http');          // 核心模块
	var http = require('http_custom');   // 更换标识符
	var http = require('./http');        // 路径方式引入

**路径形式的文件模块**以`.` 、`..` 、`/`开始的标识符都会当做文件模块来处理，在分析路径模块时，require()方法会将路径转为真实路径进行编译，编译执行后的结果会存储在缓存中，以使二次加载更快。 
由于文件模块给node指明了确切的文件位置，查找过程可以大量的节约时间，其速度仅此于核心模块。<br>
**自定义模块**指非核心模块同时也不是路径形式的模块，属于一种特殊的文件模块，可能是一个文件或者包的形式，查找最费时，也是最慢的一种。

	module.paths
windows系统下<br>

![](http://i.imgur.com/tbG3eHu.png)

当前目录下的node_modules,上级目录的node_modules,逐级查找直至到根目录的node_modules。文件目录越深，文件查找耗时越多。 
### 4.2 文件扩展名分析###
如果require() 方法内的参数不添加标识符，Node会按照.js、.json、.node的顺序依次加载。
### 4.3 目录分析和包###
1.通过require()方法进行查找文件所得到的可能不是一个文件而是一个目录，这时node会将这个目录当做一个包进行处理。<br>
首先node会在当前的目录下查找package.json文件，通过JSON.parse()方法将package.json进行解析成描述该包的对象，从该对象main属性指定的文件进行定位。<br>2.如果没有package.json,node会认为index当做默认的文件名，依次去查找.js、.json、.node文件。<br>3.如果在此目录分析过程中没有定位到任何文件的话，node会进入下一个模块路径进行查找。如果没有找到则直接抛错查找异常。
![](http://i.imgur.com/TtkpN07.png)
## 5. 模块编译##
编译和执行是引用模块的最后一个阶段，定位到文件后node会新建一个模块对象，然后根据路径进行载入并编译。不同的文件扩展名其载入方式也是不同的。<br>
1. .js文件。通过fs模块同步读取后编译执行。<br>
2. .node文件。使用c/c++编写的扩展文件，通过内建的process.dlopen()方法加载编译执行。<br>
3. .json文件。通过fs模块同步读取文件后，用JSON.parse()解析返回结果。<br>
4. 其余扩展名文件。当做.js文件进行载入。<br>

